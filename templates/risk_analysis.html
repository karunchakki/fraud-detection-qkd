{# templates/risk_analysis.html #}
{% extends "base.html" %}

{% block title %}Quantum-Inspired Risk Analysis - QKD Secure Bank{% endblock %}

{% block content %}
    <h2 class="text-3xl font-semibold text-gray-800 dark:text-gray-200 mb-8 text-center">Quantum-Inspired Risk Analysis (Simulation)</h2>

    <div class="max-w-4xl mx-auto space-y-8">

        {# Informational Box #}
        <div class="bg-indigo-50 dark:bg-indigo-900/30 border-l-4 border-indigo-400 text-indigo-700 dark:text-indigo-300 p-4 rounded-md shadow-sm">
            <p class="font-bold mb-1">Demonstration Purpose</p>
            <p class="text-sm">
                This section showcases simulated results inspired by potential quantum applications in finance, such as portfolio optimization or advanced risk measure calculation (VaR/CVaR). The underlying logic uses classical simulation as a placeholder for complex quantum algorithms.
            </p>
        </div>

        {# --- START: Analysis Selection Form --- #}
        <div class="bg-gray-50 dark:bg-gray-800 p-6 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm mb-8">
            <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-300 mb-4">Select Analysis Type</h3>
            {# Use GET method - parameters appear in URL, simpler for this demo #}
            <form action="{{ url_for('risk_analysis_page') }}" method="GET" class="space-y-4">
                <div class="flex flex-wrap gap-x-6 gap-y-3 items-center">
                    <div class="flex items-center">
                        <input id="type_portfolio" name="type" type="radio" value="portfolio"
                               class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 dark:border-gray-600 dark:bg-gray-700"
                               {# Check if current type is portfolio or if no type was specified (default) #}
                               {{ 'checked' if analysis_type == 'portfolio' or not analysis_type else '' }}>
                        <label for="type_portfolio" class="ml-2 block text-sm font-medium text-gray-700 dark:text-gray-300">
                            Portfolio Optimization
                        </label>
                    </div>
                    <div class="flex items-center">
                        <input id="type_risk_measure" name="type" type="radio" value="risk_measure"
                               class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 dark:border-gray-600 dark:bg-gray-700"
                               {{ 'checked' if analysis_type == 'risk_measure' else '' }}>
                        <label for="type_risk_measure" class="ml-2 block text-sm font-medium text-gray-700 dark:text-gray-300">
                            Risk Measures (VaR/CVaR)
                        </label>
                    </div>
                </div>
                {# Placeholder for future parameter inputs if needed #}
                {# Example:
                <div id="risk-measure-params" class="{{ 'hidden' if analysis_type != 'risk_measure' }}">
                     <label for="alpha" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Alpha (e.g., 0.05):</label>
                     <input type="number" step="0.01" min="0.01" max="0.2" name="alpha" value="{{ request.args.get('alpha', '0.05') }}" class="...">
                </div>
                 #}
                <div>
                    <button type="submit" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Run Simulation
                    </button>
                </div>
            </form>
        </div>
        {# --- END: Analysis Selection Form --- #}


        {# Display Simulation Results if available #}
        {% if risk_results and risk_results.status %}
            <div class="bg-white dark:bg-gray-800 shadow-lg rounded-lg p-6 border border-gray-200 dark:border-gray-700">
                <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-300 mb-4 border-b border-gray-200 dark:border-gray-700 pb-2">Simulation Results</h3>

                {# Portfolio Optimization Results #}
                {% if 'optimal_allocation' in risk_results %}
                    <h4 class="text-lg font-medium text-blue-700 dark:text-blue-400 mb-3">Simulated Portfolio Optimization</h4>
                    <div class="space-y-2 text-sm mb-4">
                        <p><strong class="text-gray-600 dark:text-gray-400 w-32 inline-block">Status:</strong>
                            <span class="{{ 'text-green-600 dark:text-green-400' if 'Success' in risk_results.status else 'text-red-600 dark:text-red-400' }} font-medium">{{ risk_results.status }}</span>
                        </p>
                        <p><strong class="text-gray-600 dark:text-gray-400 w-32 inline-block">Expected Return:</strong>
                            {# Display return as percentage #}
                            <span class="font-mono dark:text-gray-200">{{ "%.2f" | format(risk_results.expected_return * 100) }}%</span>
                        </p>
                        <p><strong class="text-gray-600 dark:text-gray-400 w-32 inline-block">Variance (Risk):</strong>
                             <span class="font-mono dark:text-gray-200">{{ "%.4f" | format(risk_results.variance | float) }}</span>
                        </p>
                    </div>
                    <strong class="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">Optimal Allocation:</strong>
                    {% if risk_results.optimal_allocation %}
                        <ul class="list-disc pl-5 space-y-1 text-sm dark:text-gray-300">
                        {% for asset, weight in risk_results.optimal_allocation.items() %}
                            {# Display weight directly as it's already percentage #}
                            <li>{{ asset }}: <span class="font-semibold font-mono">{{ "%.2f" | format(weight | float) }}%</span></li>
                        {% endfor %}
                        </ul>
                    {% else %}
                        <p class="text-sm text-gray-500 dark:text-gray-400 italic">Allocation data not available.</p>
                    {% endif %}

                {# Risk Measure Estimation Results #}
                {% elif 'value_at_risk' in risk_results %}
                     <h4 class="text-lg font-medium text-purple-700 dark:text-purple-400 mb-3">Simulated Risk Measure Estimation</h4>
                     <div class="space-y-2 text-sm">
                         <p><strong class="text-gray-600 dark:text-gray-400 w-48 inline-block">Status:</strong>
                            <span class="{{ 'text-green-600 dark:text-green-400' if 'Success' in risk_results.status else 'text-red-600 dark:text-red-400' }} font-medium">{{ risk_results.status }}</span>
                         </p>
                          <p><strong class="text-gray-600 dark:text-gray-400 w-48 inline-block">Confidence Level:</strong>
                             <span class="font-mono dark:text-gray-200">{{ "%.1f" | format(risk_results.confidence_level * 100) }}%</span>
                         </p>
                         <p><strong class="text-gray-600 dark:text-gray-400 w-48 inline-block">Value at Risk (VaR):</strong>
                             {# Display VaR as percentage #}
                              <span class="font-mono dark:text-gray-200">{{ "%.2f" | format(risk_results.value_at_risk | float) }}%</span>
                             <span class="text-xs text-gray-500 dark:text-gray-400">(Max expected loss)</span>
                         </p>
                         <p><strong class="text-gray-600 dark:text-gray-400 w-48 inline-block">Conditional VaR (CVaR):</strong>
                             {# Display CVaR as percentage #}
                              <span class="font-mono dark:text-gray-200">{{ "%.2f" | format(risk_results.conditional_value_at_risk | float) }}%</span>
                             <span class="text-xs text-gray-500 dark:text-gray-400">(Expected loss if VaR exceeded)</span>
                         </p>
                     </div>

                {# Fallback if structure is unexpected #}
                {% else %}
                    <p><strong class="text-gray-600 dark:text-gray-400">Status:</strong>
                        <span class="{{ 'text-green-600 dark:text-green-400' if 'Success' in risk_results.status else 'text-red-600 dark:text-red-400' }} font-medium">{{ risk_results.status }}</span>
                    </p>
                    <p class="text-sm text-gray-500 dark:text-gray-400 italic mt-2">Simulation ran, but results format not recognized for detailed display.</p>
                    <pre class="text-xs bg-gray-100 dark:bg-gray-700 p-2 rounded mt-2 overflow-x-auto"><code class="dark:text-gray-200">{{ risk_results | tojson(indent=2) }}</code></pre> {# Display raw data if unknown #}
                {% endif %}

            </div> {# End results card #}

        {% else %}
            {# Message if no simulation results are available #}
             <div class="bg-yellow-50 dark:bg-yellow-900/30 border-l-4 border-yellow-400 text-yellow-700 dark:text-yellow-300 p-4 rounded-md shadow-sm" role="alert">
                 <p class="font-bold">No Simulation Data</p>
                 <p class="text-sm">Select an analysis type and click "Run Simulation" to view results.</p>
             </div>
        {% endif %}

         <!-- Navigation back to dashboard -->
        <div class="mt-8 text-center border-t border-gray-200 dark:border-gray-700 pt-6">
            <a href="{{ url_for('index') }}" class="inline-block bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-5 rounded-lg shadow transition duration-300 text-sm">
                ‚Üê Back to Dashboard
            </a>
        </div>

    </div> {# End max-width container #}
{% endblock %}