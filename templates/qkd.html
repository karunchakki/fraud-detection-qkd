{% extends "base.html" %}

{% block title %}QKD BB84 Simulation Details{% endblock %}

{% block head_extra %}
    {# Include Chart.js CDN library #}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
    <h2 class="text-3xl font-semibold text-gray-800 dark:text-gray-200 mb-8 text-center">BB84 QKD Protocol Simulation Details</h2>

    <!-- Simulation Output Display -->
    {% if simulation_log %} {# Check if results from the last run exist in the session #}
        <div class="space-y-8">

            {# Summary Box #}
            <div class="bg-gray-50 dark:bg-gray-800 p-6 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm">
                <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-300 mb-3">Run Summary</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                    <div><span class="font-medium text-gray-600 dark:text-gray-400">Initial Qubits:</span> <span class="dark:text-gray-200">{{ simulation_log.get('initial_qubits', 'N/A') }}</span></div>
                    <div><span class="font-medium text-gray-600 dark:text-gray-400">Sifted Bits:</span> <span class="dark:text-gray-200">{{ simulation_log.get('sifted_indices_count', 'N/A') }}</span></div>
                    <div><span class="font-medium text-gray-600 dark:text-gray-400">QBER Samples:</span> <span class="dark:text-gray-200">{{ simulation_log.get('qber_sample_count', 'N/A') }}</span></div>
                    <div><span class="font-medium text-gray-600 dark:text-gray-400">Final Key Length:</span> <span class="dark:text-gray-200">{{ simulation_log.get('final_key_length', 'N/A') }}</span></div>
                    <div class="col-span-2 md:col-span-1"><span class="font-medium text-gray-600 dark:text-gray-400">Eve Simulated?:</span>
                        <span class="{{ 'text-red-500 font-semibold' if simulation_log.get('eve_simulated') else 'text-green-500' }}">
                            {{ 'Yes' if simulation_log.get('eve_simulated') else 'No' }}
                        </span>
                    </div>
                     <div class="col-span-2 md:col-span-3"><span class="font-medium text-gray-600 dark:text-gray-400">QBER:</span>
                        {% set qber_val = simulation_log.get('qber', -1.0) %}
                        <span class="font-mono font-semibold {{ 'text-red-500' if qber_val > QBER_THRESHOLD else ('text-green-500' if qber_val >= 0 else 'text-gray-500') }}">
                            {{ "%.4f" | format(qber_val) if qber_val >= 0 else ('N/A' if qber_val == -1.0 else ('Low Bits' if qber_val == -2.0 else 'Sim Err')) }}
                        </span>
                        (<span class="font-semibold {{ 'text-red-500' if simulation_log.get('eve_detected') else 'text-green-500' }}">
                            {{ 'EVE DETECTED!' if simulation_log.get('eve_detected') else ('Threshold OK' if qber_val >= 0 else 'Status N/A') }}
                        </span>)
                    </div>
                </div>
            </div>

            <hr class="border-gray-200 dark:border-gray-700">

            {# Section 1: Initial State #}
            <div>
                <h4 class="text-xl font-semibold text-gray-700 dark:text-gray-300 mb-4">1. Initial State & Measurement Choices</h4>
                 {% set alice_bits_list = simulation_log.get('alice_bits', []) %}
                 <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">(Showing first {{ alice_bits_list | length }} qubits. Basis: 0=Z, 1=X. Green = Bases Match)</p>
                 <div class="overflow-x-auto text-xs border border-gray-200 dark:border-gray-700 rounded-md">
                    <table class="min-w-full">
                        <thead class="bg-gray-100 dark:bg-gray-700">
                            <tr>
                                <th class="px-3 py-2 font-medium text-gray-600 dark:text-gray-300 text-center">Qubit #</th>
                                <th class="px-3 py-2 font-medium text-gray-600 dark:text-gray-300 text-center">Alice Bit</th>
                                <th class="px-3 py-2 font-medium text-gray-600 dark:text-gray-300 text-center">Alice Basis</th>
                                <th class="px-3 py-2 font-medium text-gray-600 dark:text-gray-300 text-center">Bob Basis</th>
                            </tr>
                        </thead>
                        <tbody class="font-mono dark:text-gray-300">
                             {% set alice_bases_list = simulation_log.get('alice_bases', []) %}
                             {% set bob_bases_list = simulation_log.get('bob_bases', []) %}
                             {% for i in range(alice_bits_list | length) %}
                                {% set alice_base = alice_bases_list[i] if i < alice_bases_list | length else '?' %}
                                {% set bob_base = bob_bases_list[i] if i < bob_bases_list | length else '?' %}
                                {% set bases_match = alice_base == bob_base and alice_base != '?' %}
                                <tr class="text-center {{ 'bg-green-50 dark:bg-green-900/30' if bases_match else 'bg-red-50 dark:bg-red-900/30' }}">
                                    <td class="px-3 py-1 border-t border-gray-200 dark:border-gray-700">{{ i }}</td>
                                    <td class="px-3 py-1 border-t border-gray-200 dark:border-gray-700">{{ alice_bits_list[i] | default('?') }}</td>
                                    <td class="px-3 py-1 border-t border-gray-200 dark:border-gray-700">{{ alice_base }}</td>
                                    <td class="px-3 py-1 border-t border-gray-200 dark:border-gray-700">{{ bob_base }}</td>
                                </tr>
                             {% endfor %}
                        </tbody>
                    </table>
                 </div>
            </div>

            <hr class="border-gray-200 dark:border-gray-700">

            {# Section 2: Bob's Measurement Outcome #}
            <div>
                 <h4 class="text-xl font-semibold text-gray-700 dark:text-gray-300 mb-4">2. Bob's Measurement Outcome {% if simulation_log.get('eve_simulated') %}<span class="text-red-500">(Potential Eve Impact)</span>{% endif %}</h4>
                 {% if simulation_log.get('eve_simulated') %}
                    <p class="text-sm text-red-500 dark:text-red-400 mb-2">Eve simulation was active (Rate: {{ "%.3f" | format(simulation_log.get('eve_error_rate_used', 0.0)) }}), introducing approx. {{ simulation_log.get('eve_errors_introduced', 0) }} errors into Bob's results below.</p>
                 {% endif %}
                 <span class="text-sm font-medium text-gray-600 dark:text-gray-400 block mb-1">Bob's Measured Bits (Sample):</span>
                 <pre><code class="text-xs p-3 bg-gray-100 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-md block max-h-24 overflow-y-auto font-mono text-gray-800 dark:text-gray-200">{{ simulation_log.get('bob_measurement_results', []) | join('') }}</code></pre>
            </div>

            <hr class="border-gray-200 dark:border-gray-700">

            {# Section 3: Sifting & QBER Check #}
            <div>
                 <h4 class="text-xl font-semibold text-gray-700 dark:text-gray-300 mb-4">3. Sifting & QBER Check</h4>
                 <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">Detailed bit comparison requires more granular logging. QBER summary below is accurate.</p>
                 {% set qber_val = simulation_log.get('qber', -1.0) %}
                 <div class="mt-4 text-center p-4 rounded-md font-semibold
                    {% if simulation_log.get('eve_detected') %}bg-red-100 dark:bg-red-900/50 text-red-700 dark:text-red-300 border border-red-300 dark:border-red-600
                    {% elif qber_val >= 0 %}bg-green-100 dark:bg-green-900/50 text-green-700 dark:text-green-300 border border-green-300 dark:border-green-600
                    {% else %}bg-yellow-100 dark:bg-yellow-900/50 text-yellow-700 dark:text-yellow-300 border border-yellow-300 dark:border-yellow-600
                    {% endif %}">
                    Calculated QBER: {{ "%.4f" | format(qber_val) if qber_val >= 0 else 'N/A' }}
                    ({{ "%.2f" | format(qber_val * 100) if qber_val >= 0 else 'N/A' }}%)
                    - Status:
                    {% if simulation_log.get('eve_detected') %} EAVESDROPPING DETECTED (Above {{ "%.2f" | format(QBER_THRESHOLD * 100) }}% Threshold!)
                    {% elif qber_val >= 0 %} SECURE (Below Threshold)
                    {% else %} QBER CALCULATION FAILED {% endif %}
                 </div>
            </div>

             <hr class="border-gray-200 dark:border-gray-700">

            {# Section 4: Final Key Result #}
            <div>
                 <h4 class="text-xl font-semibold text-gray-700 dark:text-gray-300 mb-4">4. Final Generated Key</h4>
                 {% if simulation_log.get('final_key_binary') %}
                    <span class="text-sm font-medium text-gray-600 dark:text-gray-400 block mb-1">Final Shared Key ({{ simulation_log.get('final_key_length', '?') }} bits):</span>
                    <pre><code class="text-xs p-3 bg-gray-100 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-md block max-h-24 overflow-y-auto font-mono text-gray-800 dark:text-gray-200">{{ simulation_log.final_key_binary }}</code></pre>
                 {% elif simulation_log.get('eve_detected') %}
                    <p class="text-red-600 dark:text-red-400 font-semibold p-3 bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-700 rounded-md">No final key generated due to high QBER / Eve detection.</p>
                 {% else %}
                     {% set qber_val = simulation_log.get('qber', -1.0) %}
                     <p class="text-yellow-700 dark:text-yellow-400 font-semibold p-3 bg-yellow-50 dark:bg-yellow-900/30 border border-yellow-200 dark:border-yellow-700 rounded-md">No final key generated (Reason: {{ 'Insufficient bits' if qber_val >= 0 else 'QKD Failure / QBER Error' }}).</p>
                 {% endif %}
            </div>

            {# --- ADDED BACK: Chart.js graph --- #}
            <hr class="border-gray-200 dark:border-gray-700">
            <div>
                <h4 class="text-xl font-semibold text-gray-700 dark:text-gray-300 mb-4">QBER History</h4>
                 <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">(Shows QBER from recent successful runs)</p>
                 <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow border border-gray-200 dark:border-gray-700 relative" style="height: 300px;">
                    <canvas id="qberChart"></canvas> {# Chart.js targets this ID #}
                 </div>
            </div>
            {# --- END: Chart.js graph --- #}

            {# --- ADDED BACK: Simulation Log Samples Table --- #}
            <hr class="border-gray-200 dark:border-gray-700">
            <div>
                <h4 class="text-xl font-semibold text-gray-700 dark:text-gray-300 mb-4">5. Simulation Log Samples</h4>
                 <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">(Showing first 50 values where applicable)</p>
                 <div class="overflow-x-auto text-xs border border-gray-200 dark:border-gray-700 rounded-md">
                    <table class="min-w-full">
                        <thead class="bg-gray-100 dark:bg-gray-700">
                            <tr>
                                <th class="px-3 py-2 font-medium text-gray-600 dark:text-gray-300 text-left">Item</th>
                                <th class="px-3 py-2 font-medium text-gray-600 dark:text-gray-300 text-left">Value Sample</th>
                            </tr>
                        </thead>
                        <tbody class="font-mono dark:text-gray-300">
                             <tr class="bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700">
                                 <td class="px-3 py-2 text-left align-top"><span class="font-sans font-medium text-gray-700 dark:text-gray-300">Alice Bits:</span></td>
                                 <td class="px-3 py-2 text-left break-all">{{ simulation_log.get('alice_bits', []) | join('') }}</td>
                             </tr>
                             <tr class="bg-gray-50 dark:bg-gray-750 border-t border-gray-200 dark:border-gray-700">
                                 <td class="px-3 py-2 text-left align-top"><span class="font-sans font-medium text-gray-700 dark:text-gray-300">Alice Bases:</span></td>
                                 <td class="px-3 py-2 text-left break-all">{{ simulation_log.get('alice_bases', []) | join('') }}</td>
                             </tr>
                              <tr class="bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700">
                                 <td class="px-3 py-2 text-left align-top"><span class="font-sans font-medium text-gray-700 dark:text-gray-300">Bob Bases:</span></td>
                                 <td class="px-3 py-2 text-left break-all">{{ simulation_log.get('bob_bases', []) | join('') }}</td>
                             </tr>
                             <tr class="bg-gray-50 dark:bg-gray-750 border-t border-gray-200 dark:border-gray-700">
                                 <td class="px-3 py-2 text-left align-top"><span class="font-sans font-medium text-gray-700 dark:text-gray-300">Bob Measured:</span></td>
                                 <td class="px-3 py-2 text-left break-all">{{ simulation_log.get('bob_measurement_results', []) | join('') }}</td>
                             </tr>
                              <tr class="bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700">
                                 <td class="px-3 py-2 text-left align-top"><span class="font-sans font-medium text-gray-700 dark:text-gray-300">Sifted Key (Pre-QBER):</span></td>
                                 <td class="px-3 py-2 text-left break-all">{{ simulation_log.get('sifted_key_sample', 'N/A') }}</td>
                             </tr>
                        </tbody>
                    </table>
                 </div>
            </div>
            {# --- END: Simulation Log Samples Table --- #}

            {# --- ADDED BACK: Download Button for QKD Sim Report --- #}
            <hr class="border-gray-200 dark:border-gray-700">
            <div class="mt-8 text-center">
              {# Ensure the route name 'download_qkd_report' matches app.py #}
              <a href="{{ url_for('download_qkd_report') }}"
                 class="inline-flex items-center justify-center px-6 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150"
                 download> {# Optional: Add download attribute #}
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 -ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                </svg>
                Download Full QKD Report (PDF)
              </a>
            </div>
            {# --- END: Download Button --- #}

        </div> {# End of main results container #}

    {% else %}
        {# Message if no simulation log found #}
        <div class="bg-yellow-50 dark:bg-yellow-900/30 border-l-4 border-yellow-400 text-yellow-700 dark:text-yellow-300 p-4 rounded-md shadow-sm" role="alert">
            <div class="flex">
                <div class="py-1"><svg class="fill-current h-6 w-6 text-yellow-500 mr-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M2.93 17.07A10 10 0 1 1 17.07 2.93 10 10 0 0 1 2.93 17.07zM9 11v-4h2v4H9zm0 4h2v-2H9v2z"/></svg></div>
                <div>
                    <p class="font-bold">No Simulation Data Found</p>
                    <p class="text-sm">Perform a secure transfer on the dashboard first to generate simulation data.</p>
                </div>
            </div>
        </div>
    {% endif %}

    <!-- Navigation back to main page -->
    <div class="mt-10 text-center border-t border-gray-200 dark:border-gray-700 pt-6">
        <a href="{{ url_for('index') }}" class="inline-block bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-5 rounded-lg shadow transition duration-300 text-sm">
            ‚Üê Back to Dashboard
        </a>
    </div>

{% endblock %}

{# --- RESTORED: Full Chart JS Initialization Script --- #}
{% block scripts %}
{# Script to initialize Chart.js, using data passed from Flask #}
<script>
    // Inject data from Flask into global JS variables BEFORE qkd.js runs
    try {
        window.qkdChartLabels = {{ qber_history_labels | tojson | safe }};
        window.qkdChartQberData = {{ qber_history_values | tojson | safe }};
        window.qkdChartQberThreshold = {{ (QBER_THRESHOLD | default(0.15)) * 100 }}; // Ensure percentage
    } catch (e) {
        console.error("Error injecting chart data from Jinja:", e);
        // Set defaults if injection fails
        window.qkdChartLabels = ['Error'];
        window.qkdChartQberData = [0];
        window.qkdChartQberThreshold = 15.0;
    }
</script>
{# Load the chart initialization script (qkd.js) #}
<script src="{{ url_for('static', filename='js/qkd.js') }}"></script>
{% endblock %}