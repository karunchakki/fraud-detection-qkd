<!DOCTYPE html>
<html lang="en" class="h-full dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}QuantumVault{% endblock %}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'sans-serif'],
              mono: ['"JetBrains Mono"', 'monospace'],
            },
            colors: {
              background: '#0f172a', // Deep Slate
              surface: '#1e293b',    // Lighter Slate
              primary: '#06b6d4',    // Cyan-500
              secondary: '#8b5cf6',  // Violet-500
              danger: '#ef4444',     // Red-500
              success: '#10b981',    // Emerald-500
            },
            animation: {
              'blob': 'blob 7s infinite',
              'pulse-glow': 'pulse-glow 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
            },
            keyframes: {
              blob: {
                '0%': { transform: 'translate(0px, 0px) scale(1)' },
                '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
                '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
                '100%': { transform: 'translate(0px, 0px) scale(1)' },
              },
              'pulse-glow': {
                '0%, 100%': { opacity: 1, boxShadow: '0 0 20px rgba(6, 182, 212, 0.5)' },
                '50%': { opacity: .5, boxShadow: '0 0 10px rgba(6, 182, 212, 0.2)' },
              }
            }
          }
        }
      }
    </script>
    <style>
      /* Smooth gradients for background */
      .bg-quantum-gradient {
        background: radial-gradient(circle at top right, #1e293b, #0f172a);
      }
      /* Glassmorphism utility */
      .glass {
        background: rgba(30, 41, 59, 0.7);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.08);
      }
      .glass-card {
        background: rgba(255, 255, 255, 0.03);
        backdrop-filter: blur(16px);
        border: 1px solid rgba(255, 255, 255, 0.05);
        box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
      }
      /* Input Auto-fill fix for dark mode */
      input:-webkit-autofill,
      input:-webkit-autofill:hover, 
      input:-webkit-autofill:focus, 
      input:-webkit-autofill:active{
          -webkit-box-shadow: 0 0 0 30px #1e293b inset !important;
          -webkit-text-fill-color: white !important;
      }
    </style>
</head>
<body class="bg-background text-slate-200 antialiased h-full selection:bg-primary selection:text-white">

    <!-- Flash Messages Toast Container (Top Right) -->
    <div class="fixed top-5 right-5 z-50 flex flex-col gap-2 w-full max-w-sm pointer-events-none">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                <div class="pointer-events-auto p-4 rounded-xl border shadow-2xl backdrop-blur-md transform transition-all duration-300 hover:scale-105
                    {% if 'error' in category %} bg-red-950/80 border-red-500/50 text-red-200
                    {% elif 'success' in category %} bg-emerald-950/80 border-emerald-500/50 text-emerald-200
                    {% elif 'SECURITY ALERT' in message %} bg-red-950/90 border-red-500 text-white animate-pulse
                    {% else %} bg-slate-800/80 border-slate-600 text-slate-200 {% endif %}">
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            {% if 'error' in category or 'SECURITY' in message %}<i class="fa-solid fa-circle-exclamation text-xl"></i>
                            {% elif 'success' in category %}<i class="fa-solid fa-circle-check text-xl"></i>
                            {% else %}<i class="fa-solid fa-circle-info text-xl"></i>{% endif %}
                        </div>
                        <div class="ml-3 w-0 flex-1 pt-0.5">
                            <p class="text-sm font-medium">{{ message }}</p>
                        </div>
                        <button onclick="this.parentElement.parentElement.remove()" class="ml-4 flex-shrink-0 text-white/50 hover:text-white">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    </div>
                </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>

    <!-- Layout Wrapper -->
    <div class="flex h-screen overflow-hidden bg-quantum-gradient">
        
        <!-- Sidebar (Only show if logged in) -->
        {% if current_user.is_authenticated %}
        <aside class="w-72 glass flex flex-col hidden md:flex border-r border-white/5">
            <!-- Brand -->
            <div class="h-20 flex items-center px-8 border-b border-white/5">
                <div class="h-10 w-10 rounded-xl bg-gradient-to-br from-primary to-blue-600 flex items-center justify-center shadow-lg shadow-primary/20">
                    <i class="fa-solid fa-atom text-white text-xl"></i>
                </div>
                <span class="ml-3 text-xl font-bold tracking-tight text-white">QuantumVault</span>
            </div>

            <!-- Navigation -->
            <nav class="flex-1 px-4 py-8 space-y-2 overflow-y-auto">
                <p class="px-4 text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2">Platform</p>
                
                <a href="{{ url_for('index') }}" class="group flex items-center px-4 py-3 text-sm font-medium rounded-xl transition-all duration-200 {% if request.endpoint == 'index' %}bg-primary/10 text-primary border border-primary/20{% else %}text-slate-400 hover:bg-white/5 hover:text-white{% endif %}">
                    <i class="fa-solid fa-wallet w-5 mr-3 transition-colors {% if request.endpoint == 'index' %}text-primary{% else %}text-slate-500 group-hover:text-white{% endif %}"></i>
                    Dashboard
                </a>
                
                <a href="{{ url_for('history') }}" class="group flex items-center px-4 py-3 text-sm font-medium rounded-xl transition-all duration-200 {% if request.endpoint == 'history' %}bg-primary/10 text-primary border border-primary/20{% else %}text-slate-400 hover:bg-white/5 hover:text-white{% endif %}">
                    <i class="fa-solid fa-clock-rotate-left w-5 mr-3 transition-colors {% if request.endpoint == 'history' %}text-primary{% else %}text-slate-500 group-hover:text-white{% endif %}"></i>
                    Transactions
                </a>

                <p class="px-4 text-xs font-semibold text-slate-500 uppercase tracking-wider mt-8 mb-2">Security Monitoring</p>

                <a href="{{ url_for('qkd_page') }}" class="group flex items-center px-4 py-3 text-sm font-medium rounded-xl transition-all duration-200 {% if request.endpoint == 'qkd_page' %}bg-primary/10 text-primary border border-primary/20{% else %}text-slate-400 hover:bg-white/5 hover:text-white{% endif %}">
                    <i class="fa-solid fa-wave-square w-5 mr-3 transition-colors {% if request.endpoint == 'qkd_page' %}text-primary{% else %}text-slate-500 group-hover:text-white{% endif %}"></i>
                    QKD Telemetry
                </a>
                
                <a href="{{ url_for('fraud_page') }}" class="group flex items-center px-4 py-3 text-sm font-medium rounded-xl transition-all duration-200 {% if request.endpoint == 'fraud_page' %}bg-primary/10 text-primary border border-primary/20{% else %}text-slate-400 hover:bg-white/5 hover:text-white{% endif %}">
                    <i class="fa-solid fa-shield-halved w-5 mr-3 transition-colors {% if request.endpoint == 'fraud_page' %}text-primary{% else %}text-slate-500 group-hover:text-white{% endif %}"></i>
                    Fraud Intelligence
                </a>
            </nav>

            <!-- Footer User Profile -->
            <div class="p-4 border-t border-white/5 bg-black/20">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="h-9 w-9 rounded-full bg-slate-700 border border-slate-600 flex items-center justify-center text-sm font-bold text-white">
                            {{ current_user.name[0] }}
                        </div>
                        <div class="ml-3">
                            <p class="text-sm font-medium text-white truncate w-24">{{ current_user.name }}</p>
                            <span class="text-xs text-green-400 flex items-center gap-1"><span class="w-1.5 h-1.5 rounded-full bg-green-400 animate-pulse"></span> Online</span>
                        </div>
                    </div>
                    <a href="{{ url_for('logout') }}" class="p-2 rounded-lg text-slate-400 hover:text-red-400 hover:bg-red-400/10 transition-colors" title="Logout">
                        <i class="fa-solid fa-right-from-bracket"></i>
                    </a>
                </div>
            </div>
        </aside>
        {% endif %}

        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden relative">
            
            <!-- Animated Background Blobs -->
            <div class="absolute top-0 -left-4 w-96 h-96 bg-primary/20 rounded-full mix-blend-screen filter blur-[128px] opacity-30 pointer-events-none"></div>
            <div class="absolute bottom-0 -right-4 w-96 h-96 bg-secondary/20 rounded-full mix-blend-screen filter blur-[128px] opacity-30 pointer-events-none"></div>

            <!-- Content Scroll Area -->
            <main class="flex-1 overflow-y-auto p-4 md:p-8 relative z-10">
                {% block content %}{% endblock %}
            </main>
        </div>
    </div>

    {% block scripts %}{% endblock %}
    
    <script>
        // Dark mode toggle logic (Saved in local storage)
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark')
        } else {
            document.documentElement.classList.remove('dark')
        }
    </script>
</body>
</html>